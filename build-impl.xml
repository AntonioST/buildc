<?xml version="1.0" encoding="UTF-8"?>
<project default="build"
         xmlns:ivy="antlib:org.apache.ivy.ant"
         xmlns:contrib="antlib:net.sf.antcontrib">

    <target name="build" depends="init,clean,compile,jar"/>

    <!--
    initial section
    -->
    <target name="-pre-init">
        <!--empty-->
    </target>
    <target name="-init-properties" depends="-pre-init">
        <property file="build.properties"/>
    </target>
    <target name="-do-init" depends="-pre-init,-init-properties">
        <echo message="javac.source=${javac.source}"/>
        <condition property="exist.manifest.file">
            <and>
                <isset property="manifest.file"/>
                <not>
                    <equals arg1="${manifest.file}" arg2="" trim="true"/>
                </not>
                <available file="${manifest.file}"/>
            </and>
        </condition>
        <condition property="exist.splash.image">
            <and>
                <isset property="splash.image"/>
                <not>
                    <equals arg1="${splash.image}" arg2="" trim="true"/>
                </not>
                <available file="${splash.image}"/>
            </and>
        </condition>
        <condition property="exist.main.class">
            <and>
                <isset property="main.class"/>
                <not>
                    <equals arg1="${main.class}" arg2="" trim="true"/>
                </not>
            </and>
        </condition>
        <available property="exist.git" file=".git" type="dir"/>
        <available property="exist.lib" file="${lib.dir}" type="dir"/>
        <property name="test.result.dir" value="${build.dir}/result"/>
    </target>
    <!--
    chesking section
    -->
    <target name="-check-project-git-version" depends="-do-init" if="exist.git" unless="project.version">
        <tempfile property="git.version.file" deleteonexit="true"/>
        <exec executable="git" output="${git.version.file}" failonerror="true">
            <arg value="describe"/>
            <arg value="--tags"/>
        </exec>
        <loadfile property="project.version" srcfile="${git.version.file}">
            <!--remove newline character-->
            <filterchain>
                <striplinebreaks/>
            </filterchain>
        </loadfile>
        <delete file="${git.version.file}"/>
    </target>
    <target name="-check-project-snapshot-version" unless="project.version">
        <tstamp>
            <format property="stamp" pattern="yyyymmddHHMMSS"/>
        </tstamp>
        <property name="project.version" value="snapshot-${stamp}"/>
    </target>
    <target name="-check-project-version" depends="-check-project-git-version,-check-project-snapshot-version">
        <echo message="project.version=${project.version}"/>
    </target>
    <target name="-check-jar-file" depends="-check-project-version" unless="jar.file">
        <property name="jar.file" value="${project.name}-${project.version}.jar"/>
        <echo message="jar.file=${jar.file}"/>
    </target>
    <target name="-check-dir">
        <fail unless="src.dir">Must set src.dir</fail>
        <fail unless="test.dir">Must set test.dir</fail>
        <fail unless="build.dir">Must set build.dir</fail>
        <fail unless="build.classes.dir">Must set build.classes.dir</fail>
        <fail unless="build.test.dir">Must set build.test.dir</fail>
        <fail unless="build.javadoc.dir">Must set build.javadoc.dir</fail>
        <fail unless="build.jar.dir">Must set build.jar.dir</fail>
    </target>
    <target name="-check-single-file">
        <fail unless="single.file">Must set single.file</fail>
    </target>
    <target name="-check-junit" depends="init">

    </target>
    <target name="-init-check" depends="-check-jar-file,-check-dir"/>
    <!--
    initial macro section
    -->
    <target name="-init-macro-javac">
        <macrodef name="javac-macro">
            <attribute name="srcdir" default="${src.dir}"/>
            <attribute name="destdir" default="${build.classes.dir}"/>
            <attribute name="classpath" default="${compile.classpath}"/>
            <attribute name="includes" default="${src.include}"/>
            <attribute name="excludes" default="${src.exclude}"/>
            <attribute name="debug" default="${javac.debug}"/>
            <element name="customize" optional="true"/>
            <sequential>
                <javac classpath="@{classpath}"
                       srcdir="@{srcdir}"
                       sourcepath="${basedir}/@{srcdir}"
                       destdir="@{destdir}"
                       includes="@{includes}"
                       excludes="@{excludes}"
                       source="${javac.source}"
                       target="${javac.target}"
                       includeantruntime="no"
                       includejavaruntime="no"
                       debug="@{debug}"
                       listfiles="true">
                    <compilerarg line="${javac.jvmargs}"/>
                    <customize/>
                </javac>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro-javadoc">
        <macrodef name="javadoc-macro">
            <attribute name="destdir" default="${build.javadoc.dir}"/>
            <attribute name="author" default=""/>
            <attribute name="version" default=""/>
            <attribute name="charset" default="UTF-8"/>
            <attribute name="noindex" default="false"/>
            <attribute name="nonavbar" default="false"/>
            <attribute name="notree" default="false"/>
            <attribute name="private" default="false"/>
            <attribute name="splitindex" default="false"/>
            <attribute name="windowtitle" default="${project.name} API"/>
            <sequential>
                <mkdir dir="@{destdir}"/>
                <javadoc classpath="${compile.classpath}"
                         destdir="@{destdir}"
                         author="@{author}"
                         version="@{version}"
                         charset="@{charset}"
                         noindex="@{noindex}"
                         nonavbar="@{nonavbar}"
                         notree="@{notree}"
                         private="@{private}"
                         splitindex="@{splitindex}"
                         windowtitle="@{windowtitle}"
                         failonerror="true">
                    <fileset dir="${src.dir}" includes="${src.include}" excludes="${src.exclude}"/>
                </javadoc>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro-test">
        <macrodef name="test-marco">
            <element name="testcase"/>
            <sequential>
                <mkdir dir="${test.result.dir}"/>
                <junit tempdir="${test.result.dir}"
                       printsummary="on"
                       haltonfailure="false"
                       haltonerror="false"
                       fork="true">
                    <classpath path="${build.classes.dir}"/>
                    <classpath path="${build.test.dir}"/>
                    <classpath path="${runtime.test.classpath}"/>
                    <formatter type="plain"/>
                    <jvmarg line="${test.jvmargs}"/>
                    <testcase/>
                </junit>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro-test-all" depends="-init-macro-test">
        <macrodef name="test-all-marco">
            <sequential>
                <test-marco>
                    <testcase>
                        <batchtest todir="${test.result.dir}">
                            <fileset dir="${test.dir}"/>
                        </batchtest>
                    </testcase>
                </test-marco>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro-test-single-class" depends="-init-macro-test">
        <macrodef name="test-single-class-marco">
            <attribute name="class"/>
            <sequential>
                <test-marco>
                    <testcase>
                        <test name="@{class}"
                              todir="${test.result.dir}"
                              outfile="@{class}.result"/>
                    </testcase>
                </test-marco>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro-test-single-method" depends="-init-macro-test">
        <macrodef name="test-single-method-marco">
            <attribute name="class"/>
            <attribute name="method"/>
            <sequential>
                <test-marco>
                    <testcase>
                        <test name="@{class}"
                              methods="@{method}"
                              todir="${test.result.dir}"
                              outfile="@{class}.result"/>
                    </testcase>
                </test-marco>
            </sequential>
        </macrodef>
    </target>
    <target name="-init-macro"
            depends="-init-macro-javac,-init-macro-javadoc,-init-macro-test-all,-init-macro-test-single-class,-init-macro-test-single-method"/>
    <target name="-post-init">
        <!--empty-->
    </target>
    <target name="init" depends="-pre-init,-do-init,-init-check,-init-macro,-post-init"/>
    <!--
    dependencies section
    -->
    <target name="-try-retrieve" depends="-do-init" unless="exist.lib">
        <ivy:retrieve/>
    </target>
    <target name="retrieve">
        <ivy:retrieve/>
    </target>
    <!--
    compile section
    -->
    <target name="-pre-compile">
        <!--empty-->
    </target>
    <target name="-do-compile-dir">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.classes.dir}"/>
    </target>
    <target name="-do-compile" depends="-do-compile-dir">
        <javac-macro/>
    </target>
    <target name="-do-resource" if="res.dir">
        <mkdir dir="${build.classes.dir}/${res.dir}"/>
        <copy todir="${build.classes.dir}/${res.dir}">
            <fileset dir="${res.dir}"/>
        </copy>
    </target>

    <target name="-do-compile-single" depends="-check-single-file,-do-compile-dir">
        <javac-macro includes="${single.file}"/>
    </target>
    <target name="-post-compile">
        <!--empty-->
    </target>
    <target name="compile" depends="init,-try-retrieve,-pre-compile,-do-compile,-do-resource,-post-compile"/>
    <target name="compile-single" depends="init,-try-retrieve,-pre-compile,-do-compile-single,-post-compile"/>
    <!--
    jar section
    -->
    <target name="-pre-jar">
        <!--empty-->
    </target>
    <target name="-pre-manifest">
        <mkdir dir="${build.classes.dir}/META-INF"/>
        <property name="jar.manifest.file" value="${build.classes.dir}/META-INF/MANIFEST.MF"/>
    </target>
    <target name="-create-manifest" depends="-do-init,-pre-manifest" unless="exist.manifest.file">
        <touch file="${jar.manifest.file}"/>
    </target>
    <target name="-copy-manifest" depends="-do-init,-pre-manifest" if="exist.manifest.file">
        <copy file="manifest.file" tofile="${jar.manifest.file}"/>
    </target>
    <target name="-init-manifest" depends="-do-init,-create-manifest,-copy-manifest"/>
    <target name="-do-manifest-main-class" depends="-init-manifest" if="main.class">
        <manifest file="${jar.manifest.file}" mode="update">
            <attribute name="Main-Class" value="${main.class}"/>
        </manifest>
    </target>
    <target name="-do-manifest-classpath" depends="-init-manifest" if="copy.lib">
        <contrib:for list="${runtime.classpath}" param="cp" delimiter=":">
            <sequential>
                <manifest file="${jar.manifest.file}" mode="update">
                    <attribute name="Class-Path" value="@{cp}"/>
                </manifest>
            </sequential>
        </contrib:for>
    </target>
    <target name="-do-manifest-splash" depends="-do-init,-init-manifest" if="exist.splash.image">
        <basename file="${splash.image}" property="splash.image.basename"/>
        <mkdir dir="${build.classes.dir}/META-INF"/>
        <copy failonerror="false" file="${splash.image}" todir="${build.classes.dir}/META-INF"/>
        <manifest file="${jar.manifest.file}" mode="update">
            <attribute name="SplashScreen-Image" value="META-INF/${splash.image.basename}"/>
        </manifest>
    </target>
    <target name="-do-manifest" depends="-do-manifest-main-class,-do-manifest-classpath,-do-manifest-splash"/>
    <target name="-do-jar">
        <echo message="manifest=${jar.manifest.file}"/>
        <echo message="jar=${jar.file}"/>
        <jar destfile="${build.jar.dir}/${jar.file}">
            <fileset dir="${build.classes.dir}"/>
        </jar>
    </target>
    <target name="-copy-lib" if="copy.lib">
        <mkdir dir="${build.jar.dir}/${lib.dir}"/>
        <contrib:for list="${runtime.classpath}" param="cp" delimiter=":">
            <sequential>
                <copy file="@{cp}" todir="${build.jar.dir}/${lib.dir}"/>
            </sequential>
        </contrib:for>
    </target>
    <target name="-post-jar">
        <!--empty-->
    </target>
    <target name="jar" depends="init,compile,-pre-jar,-do-manifest,-do-jar,-copy-lib,-post-jar"/>
    <!--
    javadoc section
   -->
    <target name="javadoc" depends="init">
        <javadoc-macro/>
    </target>

    <!--
    run section
    -->
    <target name="run" depends="init,compile">
        <fail unless="main.class">Must set main.class</fail>
        <java classpath="${runtime.classpath}:${build.classes.dir}"
              classname="${main.class}">
            <jvmarg line="${java.jvmargs}"/>
        </java>

    </target>
    <target name="run-jar" depends="init,compile,jar">
        <java classpath="${runtime.classpath}:${build.classes.dir}"
              jar="${build.jar.dir}/${jar.file}">
            <jvmarg line="${java.jvmargs}"/>
        </java>
    </target>
    <target name="run-single" depends="init,compile,-check-single-file">
        <java classpath="${runtime.classpath}:${build.classes.dir}"
              classname="${single.file}">
            <jvmarg line="${java.jvmargs}"/>
        </java>
    </target>
    <!--
    test section
    -->
    <target name="-build-test">
        <mkdir dir="${build.test.dir}"/>
        <javac-macro classpath="${build.classes.dir}:${compile.test.classpath}"
                     srcdir="${test.dir}"
                     destdir="${build.test.dir}"/>
    </target>
    <target name="-pre-test">
        <!--empty-->
    </target>
    <target name="-do-test">
        <test-all-marco/>
    </target>
    <target name="-do-test-get-class-name" depends="-check-single-file">
        <contrib:propertyregex property="test.class.name"
                               input="${single.file}"
                               regexp="${test.dir}/(.+)\.java"
                               select="\1"/>
        <contrib:propertyregex property="test.class.name"
                               input="${test.class.name}"
                               regexp="/"
                               replace="."
                               override="true"/>
    </target>
    <target name="-do-test-single-class" depends="-do-test-get-class-name">
        <test-single-class-marco class="${test.class.name}"/>
    </target>
    <target name="-do-test-single-method" depends="-do-test-get-class-name">
        <fail unless="single.method">Must set single.method</fail>
        <test-single-method-marco class="${test.class.name}"
                                  method="${single.method}"/>
    </target>
    <target name="-post-test">
        <!--empty-->
    </target>
    <target name="test" depends="init,compile,-build-test,-pre-test,-do-test,-post-test"/>
    <target name="test-single-class" depends="init,compile,-build-test,-pre-test,-do-test-single-class,-post-test"/>
    <target name="test-single-method" depends="init,compile,-build-test,-pre-test,-do-test-single-method,-post-test"/>
    <!--
    release section
    -->
    <target name="-pre-release">
        <!--empty-->
    </target>
    <target name="-init-release">
        <mkdir dir="${release.dir}"/>
    </target>
    <target name="-do-release-bin">
        <zip destfile="${release.dir}/${project.name}-${project.version}-bin.zip">
            <fileset dir="${build.jar.dir}"/>
        </zip>
    </target>
    <target name="-do-release-src" if="release.src">
        <zip destfile="${release.dir}/${project.name}-${project.version}-src.zip">
            <fileset dir="${src.dir}"/>
            <fileset dir="${res.dir}"/>
        </zip>
    </target>
    <target name="-do-release-javadoc" if="release.javadoc">
        <zip destfile="${release.dir}/${project.name}-${project.version}-javadoc.zip">
            <fileset dir="${build.javadoc.dir}"/>
        </zip>
    </target>
    <target name="-post-release">
        <!--empty-->
    </target>
    <target name="release-bin" depends="init,compile,test,-pre-release,-init-release,-do-release-bin,-post-release"/>
    <target name="release-src" depends="init,-pre-release,-init-release,-do-release-src,-post-release"/>
    <target name="release-javadoc" depends="init,javadoc,-pre-release,-init-release,-do-release-javadoc,-post-release"/>
    <target name="release"
            depends="init,compile,test,-pre-release,-init-release,-do-release-bin,-do-release-src,-do-release-javadoc,-post-release"/>
    <!--
    clean section
    -->
    <target name="-do-clean">
        <delete dir="${build.dir}"/>
    </target>
    <target name="-post-clean">
        <!--empty-->
    </target>
    <target name="clean" depends="init,-do-clean,-post-clean"/>
    <target name="clean-all" depends="init, clean">
        <delete dir="${lib.dir}"/>
    </target>
</project>