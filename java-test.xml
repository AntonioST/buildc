<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:if="ant:if"
         xmlns:unless="ant:unless">

    <!--===============
    Directory Structure
    ===================
    .
    ├ test          ${test.dir}
    ├ lib           ${lib.dir}
    │ └ test        ${lib.test.dir}
    └ build         ${build.dir}
      ├ classes     ${build.classes.dir}
      └ test
        ├ classes   ${build.test.dir}
        └ result    ${test.result.dir}

    ================-->

    <!--==============
    dependence library
    ==================

    ==junit==
    http://mvnrepository.com/artifact/junit/junit

    ================-->

    <!--===========
    import checking
    ============-->
    <fail unless="define.java">should import 'build-java.xml'</fail>
    <fail if="define.test">'test' has imported</fail>
    <import file="ant-echo.xml"/>
    <property name="define.test" value=""/>
    <property name="define.test.junit" value=""/>

    <!--=========
    global define
    ==========-->
    <property name="test.dir" value="test"/>
    <property name="lib.test.dir" value="${lib.dir}/test"/>

    <!--============
    initial checking
    =============-->
    <available property="exist.test" file="${test.dir}" type="dir"/>
    <fail unless="exist.test">directory ${test.dir} doesn't exist</fail>

    <!--====================
    custom extension section
    =====================-->
    <extension-point name="-pre-compile-test"/>
    <extension-point name="-post-compile-test"/>
    <extension-point name="-pre-test"/>
    <extension-point name="-post-test"/>

    <!--=================
    Help Document Section
    ==================-->
    <target name="-help-test" extensionOf="-help-extend">
        <echo>compile-test : compile test file under ${test.dir}</echo>
        <echo>compile-test-class : compile test file under ${test.dir}</echo>
        <echo>run-test-class : run class file under ${test.dir}</echo>
        <echo>test : test project</echo>
        <echo>test-class : run a test class, use property 'class' to set class</echo>
        <echo>test-method : run a test method, use property 'class' and 'method' to set method</echo>
    </target>

    <!--==============
    task define : init
    ===============-->
    <target name="-test-init-property" depends="init">
        <property name="build.test.dir" value="${build.dir}/test/classes"/>
        <property name="test.result.dir" value="${build.dir}/test/result"/>
    </target>
    <target name="-test-init-classpath" depends="-test-init-property">
        <available property="exist.lib.test.dir" file="${lib.test.dir}" type="dir"/>
        <path id="real.test.classpath">
            <pathelement path="${classpath}" if:set="classpath"/>
            <pathelement path="${master.classpath}" if:set="master.classpath"/>
            <pathelement path="${compile.classpath}" if:set="compile.classpath"/>
            <pathelement path="${runtime.classpath}" if:set="runtime.classpath"/>
            <pathelement path="${test.classpath}" if:set="test.classpath"/>
            <fileset dir="${lib.test.dir}" if:set="exist.lib.test.dir">
                <include name="*.jar"/>
            </fileset>
            <pathelement path="${res.dir}" if:set="exist.res"/>
        </path>
    </target>
    <target name="-test-init" depends="-test-init-classpath,init-classpath">
        <!--initial classpath for testing-->
        <mkdir dir="${build.test.dir}"/>
        <!--macro define-->
        <macrodef name="marco-test">
            <element name="customize" implicit="true"/>
            <sequential>
                <mkdir dir="${test.result.dir}"/>
                <junit tempdir="/tmp"
                       printsummary="off"
                       haltonfailure="false"
                       haltonerror="false"
                       fork="true"
                       failureproperty="test.fail">
                    <formatter type="brief"/>
                    <classpath refid="real.test.classpath"/>
                    <classpath path="${build.classes.dir}"/>
                    <classpath path="${build.test.dir}"/>
                    <customize/>
                </junit>
            </sequential>
        </macrodef>
    </target>
    <target name="-echo-test-classpath" depends="-test-init-classpath" extensionOf="-echo-classpath-extend">
        <pathconvert property="temp.real.test.classpath" refid="real.test.classpath"/>
        <echo>real.test.classpath=${temp.real.test.classpath}</echo>
    </target>

    <!--======================
    task define : compile test
    =======================-->
    <target name="-compile-test" depends="compile,-test-init,-pre-compile-test">
        <macro-javac src="${test.dir}"
                     dest="${build.test.dir}">
            <classpath path="${build.classes.dir}"/>
            <classpath refid="real.test.classpath"/>
        </macro-javac>
    </target>
    <target name="-compile-test-class" depends="-compile-prepare,-test-init,-pre-compile-test">
        <fail unless="class">Must set 'class'</fail>
        <script language="javascript" unless:set="class.src"><![CDATA[
            var p = self.getProject();
            var c = p.getProperty('class');
            if (c.endsWith('Test')) {
                p.setProperty('class.src', c.substring(0, c.length() - 4));
            }
        ]]></script>
        <to-file-path property="tmp.compile.src.class" value="${class.src}" if:set="class.src"/>
        <to-file-path property="tmp.compile.test.class" value="${class}"/>
        <macro-javac src="${src.dir}"
                     dest="${build.classes.dir}"
                     includes="${tmp.compile.src.class}"
                     if:set="tmp.compile.src.class">
            <classpath path="${build.classes.dir}"/>
            <classpath refid="real.compile.classpath"/>
        </macro-javac>
        <macro-javac src="${test.dir}"
                     dest="${build.test.dir}"
                     includes="${tmp.compile.test.class}">
            <classpath path="${build.classes.dir}"/>
            <classpath refid="real.test.classpath"/>
        </macro-javac>
    </target>
    <target name="compile-test" depends="-compile-test,-post-compile-test"/>
    <target name="compile-test-class" depends="-compile-test-class,-post-compile-test"/>

    <!--==============
    task define : run
    ===============-->
    <target name="run-test-class" depends="compile-test-class">
        <fail unless="class">Must set 'class'</fail>
        <java classname="${class}"
              fork="true"
              failonerror="flase">
            <classpath path="${real.test.classpath}"/>
            <classpath path="${build.classes.dir}"/>
            <classpath path="${build.test.dir}"/>
            <classpath path="${res.dir}"/>
            <jvmarg line="${java.jvmargs}" if:set="java.jvmargs"/>
            <arg line="${program.args}" if:set="program.args"/>
        </java>
    </target>

    <!--==============
    task define : test
    ===============-->
    <target name="-test" depends="compile-test,-pre-test">
        <delete dir="${test.result.dir}" failonerror="false"/>
        <marco-test>
            <batchtest todir="${test.result.dir}">
                <fileset dir="${test.dir}"/>
            </batchtest>
        </marco-test>
        <macro-cat-dir srcdir="${test.result.dir}"/>
    </target>
    <target name="-test-class" depends="compile-test-class,-pre-test">
        <fail unless="class">Must set 'class'</fail>
        <marco-test>
            <test name="${class}"
                  todir="${test.result.dir}"/>
        </marco-test>
        <macro-cat srcfile="${test.result.dir}/TEST-${class}.txt"/>
    </target>
    <target name="-test-method" depends="compile-test-class,-pre-test">
        <fail unless="class">Must set 'class'</fail>
        <fail unless="method">Must set 'method'</fail>
        <marco-test>
            <test name="${class}"
                  methods="${method}"
                  todir="${test.result.dir}"/>
        </marco-test>
    </target>
    <target name="-test-check">
        <fail if="test.fail">test failed</fail>
    </target>

    <!--=======
    task define
    ========-->
    <target name="test" depends="-test,-post-test,-test-check"/>
    <target name="test-class" depends="-test-class,-post-test,-test-check"/>
    <target name="test-method" depends="-test-method,-post-test,-test-check"/>
</project>
