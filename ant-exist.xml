<?xml version="1.0" encoding="UTF-8"?>
<project>
    <macrodef name="macro-exist">
        <attribute name="property"/>
        <attribute name="path"/>
        <attribute name="type" default=""/>
        <!-- type :
                (empty) : test exist
                f file  : test exist and is a file
                d dir directory : test exist and is a directory
                l link  : test exist and is a symbolic link
                c class : test exist and is a java source file
        -->
        <attribute name="setonfail" default="false"/>
        <attribute name="setvalue" default="true"/>
        <attribute name="setfalsevalue" default="false"/>
        <sequential>
            <script language="javascript"><![CDATA[
                var j = self.getProject();
                var F = java.nio.file.Files;
                var P = java.nio.file.Paths;
                var test = false;
                if ("@{path}".length == 0 || "@{path}".contains("$")) {
                } else {
                    var p = P.get("@{path}");
                    if ("@{type}" == ''){
                        test = F.exists(p);
                    } else if ("@{type}" == 'f' || "@{type}" == 'file') {
                        test = F.isRegularFile(p);
                    } else if ("@{type}" == 'd' || "@{type}" == 'dir' || "@{type}" == 'directory') {
                        test = F.isDirectory(p);
                    } else if ("@{type}" == 'l' || "@{type}" == 'link') {
                        test = F.isSymbolicLink(p);
                    } else if ("@{type}" == 'c' || "@{type}" == 'class') {
                        var src = j.getProperty('src.dir');
                        if (src == null) {
                            var fail = j.createTask('fail');
                            fail.setMessage('src.dir not defined');
                            fail.perform();
                        }
                        test = F.exists(P.get(src).resolve("@{path}".replaceAll('\\.', '/').concat('.java')));
                    } else {
                        var fail = j.createTask('fail');
                        fail.setMessage("illegal check exist type : @{type}");
                        fail.perform();
                    }
                }
                if (test){
                    j.setProperty("@{property}", '@{setvalue}');
                } else if (java.lang.Boolean.valueOf("@{setonfail}")) {
                    j.setProperty("@{property}", '@{setfalsevalue}');
                }
            ]]></script>
        </sequential>
    </macrodef>
</project>