<?xml version="1.0" encoding="UTF-8"?>
<project>
    <!--==============
   dependence library
   ==================

   name    : TestNG
   site    : http://mvnrepository.com/artifact/org.testng/testng

   ================-->

    <!--===========
    import checking
    ============-->
    <fail unless="define.java">should import 'build-java.xml'</fail>
    <fail if="define.test">'test' has imported</fail>
    <property name="define.test" value=""/>

    <!--=========
    global define
    ==========-->
    <property name="test.dir" value="test"/>
    <property name="lib.test.dir" value="${lib.dir}/test"/>

    <!--============
    initial checking
    =============-->
    <available property="exist.test" file="${test.dir}" type="dir"/>
    <fail unless="exist.test">directory ${test.dir} doesn't exist</fail>

    <!--==
    import
    ===-->
    <import file="ant-classpath.xml"/>

    <!--====================
    custom extension section
    =====================-->
    <extension-point name="-pre-compile-test"/>
    <extension-point name="-post-compile-test"/>
    <extension-point name="-pre-test"/>
    <extension-point name="-post-test"/>

    <!--=======
    task define
    ========-->
    <target name="-help-test" extensionOf="-help-extend">
        <echo>compile-test : compile test file under ${test.dir}</echo>
        <echo>compile-test-class : compile test file under ${test.dir}</echo>
        <echo>test : test project</echo>
        <echo>test-class : run a test class</echo>
    </target>
    <target name="-test-init" depends="init,init-classpath">
        <!--task define-->
        <taskdef classpath="${lib.test.dir}/testng.jar"
                 resource="testngtasks"
                 onerror="failall"/>
        <!--default property-->
        <property name="build.test.dir" value="${build.dir}/test/classes"/>
        <property name="test.result.dir" value="${build.dir}/test/result"/>
        <!--initial classpath for testing-->
        <property name="test.classpath" value=""/>
        <list-path property="lib.test.classpath" dir="${lib.test.dir}"/>
        <path-append property="real.test.classpath" path="${master.classpath}"/>
        <path-append property="real.test.classpath" path="${test.classpath}"/>
        <path-append property="real.test.classpath" path="${lib.test.classpath}"/>
        <echo message="[classpath] real.test.classpath=${real.test.classpath}" level="verbose"/>
        <mkdir dir="${build.test.dir}"/>
        <!--macro define-->
        <macrodef name="marco-test">
            <element name="customize" implicit="true"/>
            <sequential>
                <mkdir dir="${test.result.dir}"/>
                <testng outputdir="${test.result.dir}"
                        failureProperty="test.fail">
                    <classpath path="${real.test.classpath}"/>
                    <classpath path="${build.classes.dir}"/>
                    <classpath path="${build.test.dir}"/>
                    <customize/>
                </testng>
            </sequential>
        </macrodef>
    </target>
    <target name="-compile-test-prepare" depends="compile,-test-init,-pre-compile-test"/>
    <target name="-compile-test" depends="-compile-test-prepare">
        <macro-javac src="${test.dir}"
                     dest="${build.test.dir}">
            <classpath path="${build.classes.dir}"/>
            <classpath path="${real.test.classpath}"/>
        </macro-javac>
    </target>
    <target name="-compile-test-class-prepare" depends="-compile-init,-test-init,-pre-compile-test"/>
    <target name="-compile-test-class" depends="-compile-test-class-prepare">
        <fail unless="class">Must set 'class'</fail>
        <macro-javac src="${test.dir}"
                     dest="${build.test.dir}"
                     includes="${class}">
            <classpath path="${build.classes.dir}"/>
            <classpath path="${real.test.classpath}"/>
        </macro-javac>
    </target>
    <target name="compile-test" depends="-compile-test,-post-compile-test"/>
    <target name="compile-test-class" depends="-compile-test-class,-post-compile-test"/>
    <target name="-test-prepare" depends="-test-init,compile-test,-pre-test">
        <property name="test.jvmargs" value=""/>
    </target>
    <target name="-test-xml" depends="-test-prepare" if="testng.xml.fileset">
        <delete dir="${test.result.dir}" failonerror="false"/>
        <marco-test>
            <xmlfileset refid="testng.xml.fileset"/>
        </marco-test>
    </target>
    <target name="-test-all" depends="-test-prepare" unless="testng.xml.fileset">
        <delete dir="${test.result.dir}" failonerror="false"/>
        <marco-test>
            <classfileset dir="${build.test.dir}" includes="**/*.class"/>
        </marco-test>
    </target>
    <target name="-test-class" depends="-test-prepare">
        <fail unless="class">Must set 'class'</fail>
        <marco-test>
            <classfileset dir="${build.test.dir}" includes="**/${class}.class"/>
        </marco-test>
    </target>
    <target name="-test-check">
        <fail if="test.fail">test fail</fail>
    </target>
    <target name="test" depends="-test-xml,-test-all,-post-test,-test-check"/>
    <target name="test-class" depends="-test-class,-post-test,-test-check"/>
</project>
