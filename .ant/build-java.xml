<?xml version="1.0" encoding="UTF-8"?>
<project>
    <target name="default" depends="init,compile,test,jar"/>
    <!--
    global property
    -->
    <property name="src.dir" value="src"/>
    <property name="test.dir" value="test"/>
    <property name="build.dir" value="build"/>
    <property name="res.dir" value="res"/>
    <property name="lib.dir" value="lib"/>
    <property name="lib.master.dir" value="${lib.dir}/master"/>
    <property name="lib.compile.dir" value="${lib.dir}/compile"/>
    <property name="lib.runtime.dir" value="${lib.dir}/runtime"/>
    <property name="lib.test.dir" value="${lib.dir}/test"/>
    <!--
    import
    -->
    <import file="ant-git.xml"/>
    <import file="ant-exist.xml"/>
    <import file="ant-classpath.xml"/>
    <import file="ant-javac.xml"/>
    <import file="ant-junit.xml"/>
    <import file="ant-make.xml"/>
    <!--
    custom section
    -->
    <extension-point name="-pre-init"/>
    <extension-point name="-post-init"/>
    <extension-point name="-pre-compile"/>
    <extension-point name="-post-compile"/>
    <extension-point name="-pre-jar"/>
    <extension-point name="-post-jar"/>
    <extension-point name="-pre-test"/>
    <extension-point name="-post-test"/>
    <extension-point name="-pre-run"/>
    <extension-point name="-post-run"/>
    <extension-point name="-post-clean"/>
    <!--
    initial section
    -->
    <target name="-init-properties" depends="-pre-init">
        <property file="${basedir}/build.properties"/>
    </target>
    <target name="-init-version" depends="-def-macro-git-describe" if="exist.git">
        <git-describe property="project.version"/>
    </target>
    <target name="-init" depends="-pre-init,-init-properties,-init-version,-def-macro-exist">
        <property name="project.name" value="${ant.project.name}"/>
        <tstamp>
            <format property="stamp" pattern="yyyyMMdd"/>
        </tstamp>
        <property name="project.version" value="snapshot-${stamp}"/>
        <property name="jar.file" value="${project.name}-${project.version}.jar"/>
        <!--default directory-->
        <property name="build.classes.dir" value="${build.dir}/classes"/>
        <property name="build.test.dir" value="${build.dir}/test/classes"/>
        <property name="build.javadoc.dir" value="${build.dir}/javadoc"/>
        <property name="build.jar.dir" value="${build.dir}/jar"/>
        <property name="build.meta.dir" value="${build.dir}/META-INF"/>
        <property name="test.result.dir" value="${build.dir}/test/result"/>
        <property name="jar.lib.dir" value="lib"/>
        <!--exist property-->
        <macro-exist property="exist.main.class" path="${main.class}" type="class"/>
        <available property="exist.res" file="${res.dir}" type="dir"/>
        <!--default value-->
        <property name="javac.source" value="1.8"/>
        <property name="javac.target" value="1.8"/>
        <property name="javac.debug" value="true"/>
        <property name="javac.jvmargs" value=""/>
        <property name="src.include" value="**"/>
        <property name="src.exclude" value=""/>
        <property name="release.src" value="false"/>
        <property name="release.javadoc" value="false"/>
        <property name="jar.lib.copy" value="true"/>
        <!--verbose-->
        <echo message="[source] include=${src.include}" level="verbose"/>
        <echo message="[source] exclude=${src.exclude}" level="verbose"/>
        <echo message="[javac] source=${javac.source}" level="verbose"/>
        <echo message="[javac] target=${javac.target}" level="verbose"/>
    </target>
    <target name="-init-classpath" depends="-init,-def-macro-list-path,-def-macro-path-append">
        <!--default classpath-->
        <property name="master.classpath" value=""/>
        <property name="compile.classpath" value=""/>
        <property name="runtime.classpath" value=""/>
        <property name="test.classpath" value=""/>
        <list-path property="lib.compile.classpath" dir="${lib.compile.dir}"/>
        <list-path property="lib.runtime.classpath" dir="${lib.runtime.dir}"/>
        <list-path property="lib.test.classpath" dir="${lib.test.dir}"/>
        <path-append property="real.compile.classpath" path="${master.classpath}"/>
        <path-append property="real.compile.classpath" path="${compile.classpath}"/>
        <path-append property="real.compile.classpath" path="${lib.compile.classpath}"/>
        <path-append property="real.runtime.classpath" path="${master.classpath}"/>
        <path-append property="real.runtime.classpath" path="${runtime.classpath}"/>
        <path-append property="real.runtime.classpath" path="${lib.runtime.classpath}"/>
        <path-append property="real.test.classpath" path="${master.classpath}"/>
        <path-append property="real.test.classpath" path="${test.classpath}"/>
        <path-append property="real.test.classpath" path="${lib.test.classpath}"/>
        <!--verbose-->
        <echo message="[classpath] real.compile.classpath=${real.compile.classpath}" level="verbose"/>
        <echo message="[classpath] real.runtime.classpath=${real.runtime.classpath}" level="verbose"/>
        <echo message="[classpath] real.test.classpath=${real.test.classpath}" level="verbose"/>
    </target>
    <target name="init" depends="-init,-post-init"/>
    <!--
    compile section
    -->
    <target name="-compile-init" depends="init,-init-classpath">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.classes.dir}"/>
    </target>
    <target name="-compile-prepare" depends="init,-compile-init,-pre-compile,-def-macro-javac"/>
    <target name="-compile" depends="-compile-prepare">
        <macro-javac src="${src.dir}"
                     dest="${build.classes.dir}">
            <classpath path="${real.compile.classpath}"/>
        </macro-javac>
    </target>
    <target name="-compile-single" depends="-compile-prepare">
        <fail unless="class">Must set 'class'</fail>
        <macro-javac src="${src.dir}"
                     dest="${build.classes.dir}"
                     includes="${class}">
            <classpath path="${real.compile.classpath}"/>
        </macro-javac>
    </target>
    <target name="compile" depends="-compile,-post-compile"/>
    <target name="compile-single" depends="-compile-single,-post-compile"/>
    <!--
    test section
    -->
    <target name="-test-init" depends="init,compile">
        <available property="exist.test" file="${test.dir}" type="dir"/>
    </target>
    <target name="-compile-test" depends="-compile,-test-init" if="exist.test">
        <mkdir dir="${build.test.dir}"/>
        <macro-javac src="${test.dir}"
                     dest="${build.test.dir}"
                     includes="${class}">
            <classpath path="${build.classes.dir}"/>
            <classpath path="${real.test.classpath}"/>
        </macro-javac>
    </target>
    <target name="compile-test" depends="-compile-test,-post-compile" if="exist.test"/>
    <target name="-test-prepare" depends="-test-init,compile-test,-pre-test,-def-macro-test" if="exist.test">
        <property name="test.jvmargs" value=""/>
    </target>
    <target name="-test" depends="-test-prepare" if="exist.test">
        <delete dir="${test.result.dir}" failonerror="false"/>
        <marco-test output="${test.result.dir}">
            <batchtest todir="${test.result.dir}">
                <fileset dir="${test.dir}"/>
            </batchtest>
        </marco-test>
    </target>
    <target name="-test-class" depends="-test-prepare" if="exist.test">
        <fail unless="class">Must set 'class'</fail>
        <marco-test output="${test.result.dir}">
            <test name="${class}"
                  todir="${test.result.dir}"/>
        </marco-test>
    </target>
    <target name="-test-method" depends="-test-prepare" if="exist.test">
        <fail unless="class">Must set 'class'</fail>
        <fail unless="method">Must set 'method'</fail>
        <marco-test output="${test.result.dir}">
            <test name="${class}"
                  methods="${method}"
                  todir="${test.result.dir}"/>
        </marco-test>
    </target>
    <target name="test" depends="-test,-post-test" if="exist.test"/>
    <target name="test-class" depends="-test-class,-post-test" if="exist.test"/>
    <target name="test-method" depends="-test-method,-post-test" if="exist.test"/>
    <!--
    jar section
    -->
    <target name="-jar-init" depends="init,compile,-def-macro-exist">
        <mkdir dir="${build.jar.dir}"/>
        <mkdir dir="${build.meta.dir}"/>
        <macro-exist property="exist.manifest.file" path="${manifest.file}" type="file"/>
        <macro-exist property="exist.splash.file" path="${splash.image}" type="file"/>
        <macro-exist property="exist.readme.file" path="${readme.file}" type="file"/>
        <macro-exist property="exist.meta.dir" path="${res.dir}/META-INF" type="dir"/>
        <property name="jar.manifest.file" value="${build.dir}/MANIFEST.MF"/>
    </target>
    <target name="-manifest-create" depends="-jar-init" unless="exist.manifest.file">
        <touch file="${jar.manifest.file}"/>
    </target>
    <target name="-manifest-copy" depends="-jar-init" if="exist.manifest.file">
        <copy file="manifest.file" tofile="${jar.manifest.file}"/>
    </target>
    <target name="-manifest-init" depends="-manifest-copy,-manifest-create"/>
    <target name="-manifest-main-class" depends="-jar-init,-manifest-init" if="main.class">
        <manifest file="${jar.manifest.file}" mode="update">
            <attribute name="Main-Class" value="${main.class}"/>
        </manifest>
    </target>
    <target name="-manifest-classpath" depends="-init-classpath,-manifest-init" if="jar.lib.copy">
        <script language="javascript"><![CDATA[
            var p = self.getProject();
            var F = java.nio.file.Files;
            var P = java.nio.file.Paths;
            var ls = new java.util.ArrayList();
            var rt = P.get(p.getProperty('build.jar.dir'));
            var to = rt.resolve(P.get(p.getProperty('jar.lib.dir')));
            for each (var cp in p.getProperty('real.runtime.classpath').split(':')){
                if (!cp.isEmpty()){
                    var f = P.get(cp);
                    var t = to.resolve(f.getFileName());
                    if (!F.exists(t)){
                        var echo = p.createTask('echo');
                        echo.setMessage('move ' + f + ' -> ' + t);
                        echo.perform();
                        F.copy(f, t);
                    }
                    ls.add(rt.relative(t).toString());
                }
            }
            p.setProperty('jar.classpath', java.lang.String.join(' ', ls));
        ]]></script>
        <manifest file="${jar.manifest.file}" mode="update">
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </target>
    <target name="-manifest-splash" depends="-jar-init,-manifest-init" if="exist.splash.image">
        <basename file="${splash.image}" property="splash.image.basename"/>
        <mkdir dir="${build.meta.dir}"/>
        <copy failonerror="false" file="${splash.image}" todir="${build.meta.dir}"/>
        <manifest file="${jar.manifest.file}" mode="update">
            <attribute name="SplashScreen-Image" value="META-INF/${splash.image.basename}"/>
        </manifest>
    </target>
    <target name="-manifest" depends="-manifest-init,-manifest-main-class,-manifest-classpath,-manifest-splash"/>
    <target name="-jar-meta" depends="-jar-init" if="exist.meta.dir">
        <copy todir="${build.meta.dir}">
            <fileset dir="${res.dir}/META-INF"/>
        </copy>
    </target>
    <target name="-jar-readme" depends="-jar-init" if="exist.readme.file">
        <copy file="${readme.file}" todir="${build.jar.dir}"/>
    </target>
    <target name="-jar-prepare" depends="-jar-init,-manifest,-jar-meta,-jar-readme,-pre-jar"/>
    <target name="-jar" depends="-jar-prepare">
        <jar destfile="${build.jar.dir}/${jar.file}"
             manifest="${jar.manifest.file}">
            <metainf dir="${build.meta.dir}"/>
            <fileset dir="${build.classes.dir}"/>
        </jar>
    </target>
    <target name="jar" depends="-jar,-post-jar"/>
    <!--
    run section
    -->
    <target name="-run-init" depends="-def-macro-exist">
        <macro-exist property="exist.config.file" path="${config}" type="file"/>
    </target>
    <target name="-run-config" depends="-run-init" if="exist.config.file">
        <property file="${config}"/>
    </target>
    <target name="-run-prepare" depends="-run-config,init,compile,-run-init,-pre-run"/>
    <target name="-run" depends="-run-prepare">
        <fail unless="main.class">class not set</fail>
        <property name="java.jvmargs" value=""/>
        <property name="program.args" value=""/>
        <java classname="${main.class}"
              fork="true"
              failonerror="true">
            <classpath path="${real.runtime.classpath}"/>
            <classpath path="${build.classes.dir}"/>
            <jvmarg line="${java.jvmargs}"/>
            <arg line="${program.args}"/>
        </java>
    </target>
    <target name="-run-single" depends="init,compile,-run-init,-pre-run">
        <fail unless="class">class not set</fail>
        <property name="java.jvmargs" value=""/>
        <property name="program.args" value=""/>
        <java classname="${class}"
              fork="true"
              failonerror="true">
            <classpath path="${real.runtime.classpath}"/>
            <classpath path="${build.classes.dir}"/>
            <jvmarg line="${java.jvmargs}"/>
            <arg line="${program.args}"/>
        </java>
    </target>
    <target name="-run-test" depends="-run-prepare">
        <fail unless="class">class not set</fail>
        <property name="java.jvmargs" value=""/>
        <property name="program.args" value=""/>
        <java classname="${main.class}"
              fork="true"
              failonerror="true">
            <classpath path="${real.runtime.classpath}"/>
            <classpath path="${real.test.classpath}"/>
            <classpath path="${build.classes.dir}"/>
            <classpath path="${build.test.dir}"/>
            <jvmarg line="${java.jvmargs}"/>
            <arg line="${program.args}"/>
        </java>
    </target>
    <target name="-run-jar" depends="-run-prepare">
        <property name="java.jvmargs" value=""/>
        <property name="program.args" value=""/>
        <java jar="${build.jar.dir}/${jar.file}"
              fork="true"
              failonerror="true">
            <jvmarg line="${java.jvmargs}"/>
            <arg line="${program.args}"/>
        </java>
    </target>
    <target name="run" depends="-run,-post-run"/>
    <target name="run-single" depends="-run-single,-post-run"/>
    <target name="run-test" depends="-run-test,-post-run"/>
    <target name="run-jar" depends="-run-jar,-post-run"/>
    <!--
    clean section
    -->
    <target name="-clean">
        <delete dir="${build.dir}"/>
    </target>
    <target name="clean" depends="init,-clean,-post-clean"/>
    <target name="clean-all" depends="init, clean">
        <delete dir="${lib.dir}"/>
    </target>
</project>