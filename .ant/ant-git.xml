<?xml version="1.0" encoding="UTF-8"?>
<project>
    <target name="-pre-git">
        <available property="exist.git" file=".git" type="dir"/>
    </target>
    <target name="-def-macro-git" depends="-pre-git" if="exist.git">
        <exec executable="git"
              outputproperty="macro.git.output"
              resultproperty="macro.git.result"
              failonerror="true">
            <arg line="--version"/>
        </exec>
        <macrodef name="macro-git">
            <attribute name="outputproperty" default="macro.git.output"/>
            <attribute name="resultproperty" default="macro.git.result"/>
            <attribute name="failonerror" default="false"/>
            <element name="custom" implicit="true"/>
            <sequential>
                <exec executable="git"
                      outputproperty="@{outputproperty}"
                      resultproperty="@{resultproperty}"
                      failonerror="@{failonerror}">
                    <custom/>
                </exec>
            </sequential>
        </macrodef>
    </target>
    <target name="-def-macro-git-describe" depends="-pre-git,-def-macro-git" if="exist.git">
        <macrodef name="git-describe">
            <attribute name="property"/>
            <sequential>
                <macro-git outputproperty="@{property}">
                    <arg value="describe"/>
                    <arg value="--tags"/>
                </macro-git>
            </sequential>
        </macrodef>
    </target>
    <target name="-def-macro-git-current-branch" depends="-pre-git,-def-macro-git" if="exist.git">
        <macrodef name="git-current-branch">
            <attribute name="property"/>
            <sequential>
                <macro-git>
                    <arg value="branch"/>
                </macro-git>
                <script language="javascript"> <![CDATA[
                    var p = self.getProject();
                    if (p.getProperty('macro.git.result') == '0') {
                        for each (var b in p.getProperty('macro.git.output').split('\n')) {
                            if (b.startsWith('*')) {
                                p.setProperty("@{property}", b.substring(1).trim());
                            }
                        }
                    }
                ]]> </script>
            </sequential>
        </macrodef>
    </target>
    <target name="-def-task-git" depends="-def-macro-git-describe,-def-macro-git-current-branch"/>
</project>